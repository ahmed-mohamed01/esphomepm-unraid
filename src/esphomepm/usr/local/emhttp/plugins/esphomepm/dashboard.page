{{ Menu="Dashboard:0" }}
{{ Cond="version_compare(parse_ini_file('/etc/unraid-version')['version'],'7.0.0','>=') && !empty(parse_ini_file('/boot/config/plugins/esphomepm/esphomepm.cfg')['DEVICE_IP'])" }}
---
<?php
require_once(__DIR__ . '/include/functions.php');

$cfg = esphomepm_load_config();
$pluginname = 'ESPHome Power Monitor';
$unit = $cfg['COSTS_UNIT'] ?? 'GBP';

$mytiles['esphomepm']['column1'] = <<<HTML
<tbody id="esphomepm" title="$pluginname">
<tr><td>
  <i class="fa fa-plug icon"></i> $pluginname
  <a href="/Settings/ESPHomePMSettings" title="Settings"><i class="fa fa-fw fa-cog control"></i></a>
</td></tr>
<tr><td class="esphomepm-subtitle">
  Monitoring since <span class="esphomepm-monitoring"></span>
  &nbsp;&nbsp; Today: <i class="fa fa-bolt"></i> <span class="esphomepm-energy-day">--</span>kWh &nbsp; $<span class="esphomepm-cost-day">--</span> {$unit}
  &nbsp;&nbsp; Monthly: <i class="fa fa-bolt"></i> <span class="esphomepm-energy-month">--</span>kWh &nbsp; $<span class="esphomepm-cost-month">--</span> {$unit}
  &nbsp;&nbsp; Total: <i class="fa fa-bolt"></i> <span class="esphomepm-energy-total">--</span>kWh &nbsp; $<span class="esphomepm-cost-total">--</span> {$unit}
</td></tr>
</tbody>
HTML;
?>
<style>
.esphomepm-subtitle { font-size: 0.9em; color: #ccc; line-height: 1.4em; }
.esphomepm-subtitle .fa { margin: 0 4px; }
</style>
<script>
$(function(){
  function fmt(v,d){return v!=null?parseFloat(v).toFixed(d):'--';}
  function refresh(){
    $.getJSON('/plugins/esphomepm/status.php', function(data){ if(!data) return;
      $('.esphomepm-monitoring').text(data.monitoring_start_date);
      $('.esphomepm-energy-day').text(fmt(data.today_energy,3));
      $('.esphomepm-cost-day').text(fmt(data.daily_cost,2));
      $('.esphomepm-energy-month').text(fmt(data.current_month_energy_total,3));
      $('.esphomepm-cost-month').text(fmt(data.current_month_cost_total ?? data.monthly_cost_est,2));
      $('.esphomepm-energy-total').text(fmt(data.overall_total_energy,3));
      $('.esphomepm-cost-total').text(fmt(data.overall_total_cost,2));
    });
  }
  refresh(); setInterval(refresh,10000);
});
</script>

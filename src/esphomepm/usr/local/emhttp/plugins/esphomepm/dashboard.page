Menu="Dashboard:0"
Cond="version_compare(parse_ini_file('/etc/unraid-version')['version'],'7.0.0','>=') && !empty(parse_ini_file('/boot/config/plugins/esphomepm/esphomepm.cfg')['DEVICE_IP'])"
---
<?php
/*  ESPHome Power Monitor – Dashboard tile
 *  place in:  /usr/local/emhttp/plugins/esphomepm/dashboard.page
 */
require_once('/usr/local/emhttp/plugins/esphomepm/include/functions.php');

$cfg          = esphomepm_load_config();
$pluginname   = 'ESPHome Power Monitor';
$currencyUnit = $cfg['COSTS_UNIT'] ?? 'GBP';

/* build the tile --------------------------------------------------------- */
$mytiles['esphomepm']['column1'] = <<<HTML
<tbody id="esphomepm" title="$pluginname">

<!-- headline (row-1) -->
<tr><td>
  <i class="fa fa-plug icon"></i>
  <div class="section">$pluginname<span><br>
    <span class="esphomepm-current-power">0</span> W
  </span></div>
  <a href="/Settings/ESPHomePMSettings" title="Go to ESPHome Power Monitor settings">
    <i class="fa fa-fw fa-cog control"></i>
  </a>
</td></tr>

<!-- 3×3 summary – CSS grid, not a table -->
<tr><td>
  <div class="esphomepm-grid">
    <div></div><div></div><div>Day:</div><div>Month:</div><div>Total:</div>

    <div class="rowlabel">Monitoring since:</div>
    <div class="esphomepm-monitoring-date">--</div>
    <div><i class="fa fa-bolt esphomepm-energy-icon"></i> <span class="esphomepm-energy-day">--</span> kWh</div>
    <div><i class="fa fa-bolt esphomepm-energy-icon"></i> <span class="esphomepm-energy-month">--</span> kWh</div>
    <div><i class="fa fa-bolt esphomepm-energy-icon"></i> <span class="esphomepm-energy-total">--</span> kWh</div>

    <div class="rowlabel">Average Power:</div>
    <div class="esphomepm-avg-power">-- W</div>
    <div><i class="fa fa-usd esphomepm-cost-icon"></i> <span class="esphomepm-cost-day">--</span> $currencyUnit</div>
    <div><i class="fa fa-usd esphomepm-cost-icon"></i> <span class="esphomepm-cost-month">--</span> $currencyUnit</div>
    <div><i class="fa fa-usd esphomepm-cost-icon"></i> <span class="esphomepm-cost-total">--</span> $currencyUnit</div>
  </div>
</td></tr>

</tbody>
HTML;
?>

<style>
.esphomepm-energy-icon { color: #0084C6; }
.esphomepm-cost-icon { color: #EA5200; }
/* grid that mimics a 3×3 table but avoids extra <tbody> */
.esphomepm-grid{
  display:grid;
  grid-template-columns:auto auto 1fr 1fr 1fr;
  row-gap:4px; column-gap:6px;
  font-size:.9em;
  justify-items:center;
}
.esphomepm-grid .rowlabel{font-weight:600;text-align:left; justify-self:start;}
.esphomepm-grid>div:nth-child(-n+5){font-weight:600;}     /* header row */
.esphomepm-monitoring-date{justify-self:start;}
.esphomepm-avg-power{justify-self:start;}
</style>

<script>
$(function(){
  function fmt(v,d){return(v!==undefined&&v!==null)?parseFloat(v).toFixed(d):'--';}

  function refresh(){
    $.getJSON('/plugins/esphomepm/status.php',function(data){
      if(!data)return;

      $('.esphomepm-current-power').text( fmt(data.power,0) );
      $('.esphomepm-monitoring-date').text(data.monitoring_start_date);
      $('.esphomepm-avg-power').text(fmt(data.power,0)+' W');
      $('.esphomepm-energy-day')  .text(fmt(data.today_energy,3));
      $('.esphomepm-energy-month').text(fmt(data.current_month_energy_total ?? data.current_month_energy_completed_days,3));
      $('.esphomepm-energy-total').text(fmt(data.overall_total_energy,3));

      $('.esphomepm-cost-day')  .text( fmt(data.daily_cost,2) );
      $('.esphomepm-cost-month').text( fmt(data.current_month_cost_total ?? data.monthly_cost_est,2) );
      $('.esphomepm-cost-total').text( fmt(data.overall_total_cost,2) );

      if(data.cost_unit) $('.esphomepm-cost-unit').text(data.cost_unit);
    });
  }

  refresh();
  setInterval(refresh,10000);
});
</script>

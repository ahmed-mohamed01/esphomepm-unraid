Menu="Dashboard:0"
---
<?php
// Define plugin name and other variables
$pluginname = "ESPHome Power Monitor";

// Load configuration
require_once '/usr/local/emhttp/plugins/esphomepm/include/functions.php';
$config = esphomepm_load_config();
$costs_unit = isset($config['COSTS_UNIT']) ? $config['COSTS_UNIT'] : "GBP";

// Create the dashboard widget content
$mytiles['esphomepm']['column1'] = <<<EOT
<tbody class="sortable">
<tr><td class="next" colspan="2">
<i class="fa fa-plug icon"></i><div class="section">$pluginname<br><span class="esphomepm-current-power">0</span> W</div>
<i class="fa fa-fw fa-chevron-down chevron" onclick="expandESPHomePM()" id="esphomepm_expand"></i>
<a href="/Settings/ESPHomePMSettings" title="Go to ESPHome Power Monitor settings"><i class="fa fa-fw fa-cog chevron"></i></a>
</td></tr>
<tr class="esphomepm-info" style="display:none;">
<td colspan="2">
<div style="margin-top:8px;">
<table style="width:100%;">
<tr>
<td style="width:33%; text-align:center;"><b>Today</b></td>
<td style="width:33%; text-align:center;"><b>Month</b></td>
<td style="width:33%; text-align:center;"><b>Total</b></td>
</tr>
<tr>
<td style="text-align:center;"><i class="fa fa-bolt"></i> <span class="esphomepm-energy-today" style="font-weight:bold;">0.00</span> kWh</td>
<td style="text-align:center;"><i class="fa fa-bolt"></i> <span class="esphomepm-energy-month" style="font-weight:bold;">0.00</span> kWh</td>
<td style="text-align:center;"><i class="fa fa-bolt"></i> <span class="esphomepm-energy-total" style="font-weight:bold;">0.00</span> kWh</td>
</tr>
<tr>
<td style="text-align:center;"><i class="fa fa-dollar-sign"></i> <span class="esphomepm-costs-today" style="font-weight:bold; color:#F57C00;">0.00</span> $costs_unit</td>
<td style="text-align:center;"><i class="fa fa-dollar-sign"></i> <span class="esphomepm-costs-month" style="font-weight:bold; color:#F57C00;">0.00</span> $costs_unit</td>
<td style="text-align:center;"><i class="fa fa-dollar-sign"></i> <span class="esphomepm-costs-total" style="font-weight:bold; color:#F57C00;">0.00</span> $costs_unit</td>
</tr>
</table>
</div>
</td>
</tr>
</tbody>
EOT;
?>

<script>
function expandESPHomePM() {
  $('.esphomepm-info').toggle();
  $('#esphomepm_expand').toggleClass('fa-chevron-down fa-chevron-up');
}

function updateESPHomePMData() {
  $.getJSON('/plugins/esphomepm/status.php', function(data) {
    if (data) {
      $('.esphomepm-current-power').html(data.power + ' W');
      $('.esphomepm-energy-today').html(data.today_energy || data.energy_today || '0.00');
      $('.esphomepm-energy-month').html(data.current_month_energy_total || data.energy_month || '0.00');
      $('.esphomepm-energy-total').html(data.overall_total_energy || data.energy_total || '0.00');
      $('.esphomepm-costs-today').html(data.daily_cost || data.costs_today || '0.00');
      $('.esphomepm-costs-month').html(data.current_month_cost_total || data.costs_month || '0.00');
      $('.esphomepm-costs-total').html(data.overall_total_cost || data.costs_total || '0.00');
    }
  });
}

$(function() {
  updateESPHomePMData();
  setInterval(updateESPHomePMData, 10000); // Update every 10 seconds
});
</script>
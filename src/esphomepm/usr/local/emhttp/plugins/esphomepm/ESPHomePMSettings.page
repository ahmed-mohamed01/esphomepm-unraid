Menu="Utilities"
Icon="esphomepm.png"
Title="ESPHome Power Monitor"
---
<?php
$esphomepm_cfg = parse_plugin_cfg("esphomepm",true);
$esphomepm_device_ip = isset($esphomepm_cfg['DEVICE_IP']) ? $esphomepm_cfg['DEVICE_IP'] : "";
$esphomepm_device_name = isset($esphomepm_cfg['DEVICE_NAME']) ? $esphomepm_cfg['DEVICE_NAME'] : "Unraid Server PM";
$esphomepm_uirefresh = isset($esphomepm_cfg['UIREFRESH']) ? $esphomepm_cfg['UIREFRESH'] : "1000";
$esphomepm_costs_price = isset($esphomepm_cfg['COSTS_PRICE']) ? $esphomepm_cfg['COSTS_PRICE'] : "0.27";
$esphomepm_costs_unit = isset($esphomepm_cfg['COSTS_UNIT']) ? $esphomepm_cfg['COSTS_UNIT'] : "GBP";
?>

<form markdown="1" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="esphomepm/esphomepm.cfg" />

Device Name:
: <input id="DEVICE_NAME" type="text" class="stopped" name="DEVICE_NAME" maxlength="50" value="<?=$esphomepm_device_name;?>" title="" placeholder="ESPHome Device Name" >  

Device IP:
: <input id="DEVICE_IP" type="text" class="stopped" name="DEVICE_IP" maxlength="15" value="<?=$esphomepm_device_ip;?>" title="" placeholder="192.168.1.x" >  


UI Refresh rate (Milliseconds):
: <input type="text" name="UIREFRESH" class="narrow" maxlength="50" value="<?=$esphomepm_uirefresh;?>" placeholder="1000">

Price per kWh for cost calculation:
: <input id="COSTS_PRICE" type="text" class="stopped" name="COSTS_PRICE" maxlength="10" value="<?=$esphomepm_costs_price;?>" title="" placeholder="0.00" >  

Unit for cost calculation:
: <input id="COSTS_UNIT" type="text" class="stopped" name="COSTS_UNIT" maxlength="10" value="<?=$esphomepm_costs_unit;?>" title="" placeholder="" >  

 <input id="DEFAULT" class="stopped" type="submit" value="Default" onClick="resetDATA(this.form)">
: <input id="btnApply" type="submit" value="Apply"><input type="button" value="Done" onClick="done()">
</form>

<div id="deviceStatus" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none;">
    <h3>Device Status</h3>
    <div id="connectionStatus" style="margin-bottom: 10px;">
        Status: <span id="statusText">Checking...</span>
    </div>
    <div id="sensorValues" style="display: none;">
        <p>Current Power: <span id="currentPower">--</span> W</p>
        <p>Daily Energy: <span id="dailyEnergy">--</span> kWh</p>
        <p>Voltage: <span id="voltage">--</span> V</p>
        <p>Current: <span id="current">--</span> A</p>
    </div>
</div>

<script type="text/javascript">
function resetDATA(form) {
	form.DEVICE_IP.value = "";
  form.DEVICE_NAME.value = "";
  form.UIREFRESH.value = 1000;
  form.COSTS_PRICE.value = 0.27;
  form.COSTS_UNIT.value = "GBP";
}

function done() {
    window.location.href = '/Main';
}

// Function to update device status
function updateDeviceStatus() {
    const deviceIP = document.getElementById('DEVICE_IP').value;
    if (!deviceIP) {
        document.getElementById('deviceStatus').style.display = 'none';
        return;
    }

    document.getElementById('deviceStatus').style.display = 'block';
    document.getElementById('statusText').textContent = 'Checking...';
    document.getElementById('sensorValues').style.display = 'none';

    fetch(`/plugins/esphomepm/status.php`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid data received');
            }
            
            document.getElementById('statusText').textContent = 'Connected';
            document.getElementById('sensorValues').style.display = 'block';
            
            // Format numbers to 2 decimal places
            document.getElementById('currentPower').textContent = Number(data.Power).toFixed(2);
            document.getElementById('dailyEnergy').textContent = Number(data.Total).toFixed(2);
            document.getElementById('voltage').textContent = Number(data.Voltage).toFixed(2);
            document.getElementById('current').textContent = Number(data.Current).toFixed(2);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('statusText').textContent = 'Disconnected';
            document.getElementById('sensorValues').style.display = 'none';
        });
}

// Update status when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateDeviceStatus();
    // Update status every 5 seconds
    setInterval(updateDeviceStatus, 5000);
});

// Update status when IP changes
document.getElementById('DEVICE_IP').addEventListener('change', updateDeviceStatus);
</script>

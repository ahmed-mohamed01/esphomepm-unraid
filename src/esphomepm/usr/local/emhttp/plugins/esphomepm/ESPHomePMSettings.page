Menu="Utilities"
Icon="esphomepm.png"
Title="ESPHome Power Monitor"
---
<?php
require_once("/usr/local/emhttp/plugins/esphomepm/data-handler.php");
$config = load_plugin_config();
$esphomepm_device_ip = isset($config['DEVICE_IP']) ? $config['DEVICE_IP'] : "";
$esphomepm_device_name = isset($config['DEVICE_NAME']) ? $config['DEVICE_NAME'] : "Unraid Server PM";
$esphomepm_costs_price = isset($config['COSTS_PRICE']) ? $config['COSTS_PRICE'] : "0.27";
$esphomepm_costs_unit = isset($config['COSTS_UNIT']) ? $config['COSTS_UNIT'] : "GBP";

// Determine which tab to show by default
$showMonitorTab = !empty($esphomepm_device_ip);
$tab = isset($_GET['tab']) ? $_GET['tab'] : ($showMonitorTab ? 'monitoring' : 'settings');
?>

<style>
.highlight-value {
    font-size: 1.2em;
    font-weight: bold;
    color: #486DBA;
}
.info-card {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
    clear: both;
}
.notice {
    background-color: #f0f7ff;
    border-left: 4px solid #486DBA;
    padding: 15px;
    margin: 20px 0;
}
/* Fix for text overlap */
.content {
    clear: both;
    padding-top: 10px;
}
/* Improved layout for monitoring tab */
.readings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 15px;
}
.readings-item {
    margin-bottom: 10px;
}
/* Fix for history tab */
.total-stats {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}
.stat-item {
    margin-right: 30px;
    margin-bottom: 15px;
}
</style>

<div id="title">
  <span class="left">
    <input type="button" value="Settings" onclick="location='?tab=settings'" <?=($tab == 'settings') ? 'class="active"' : ''?>>
    <?php if ($showMonitorTab): ?>
    <input type="button" value="Monitoring" onclick="location='?tab=monitoring'" <?=($tab == 'monitoring') ? 'class="active"' : ''?>>
    <input type="button" value="History" onclick="location='?tab=history'" <?=($tab == 'history') ? 'class="active"' : ''?>>
    <?php endif; ?>
  </span>
</div>

<?php if ($tab == 'settings'): ?>
<div class="content">
  <div class="title"><span class="left"><i class="fa fa-cog title"></i>Device Configuration</span></div>
  <form markdown="1" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#file" value="esphomepm/esphomepm.cfg">
    
    Device Name:
    : <input type="text" name="DEVICE_NAME" value="<?=$esphomepm_device_name?>" placeholder="ESPHome Device Name">
    
    Device IP:
    : <input type="text" name="DEVICE_IP" value="<?=$esphomepm_device_ip?>" placeholder="192.168.1.x">
    
    <div class="title"><span class="left"><i class="fa fa-money title"></i>Cost Settings</span></div>
    
    Price per kWh:
    : <input type="text" name="COSTS_PRICE" value="<?=$esphomepm_costs_price?>" placeholder="0.00">
    
    Currency Unit:
    : <input type="text" name="COSTS_UNIT" value="<?=$esphomepm_costs_unit?>" placeholder="GBP">
    
    &nbsp;
    : <input type="button" value="Default" onclick="resetForm(this.form)"><input type="submit" value="Apply"><input type="button" value="Done" onclick="done()">
  </form>
  
  <?php if (empty($esphomepm_device_ip)): ?>
  <div class="notice">Please configure your ESPHome device IP address and click Apply to start monitoring.</div>
  <?php endif; ?>
</div>

<?php elseif ($tab == 'monitoring' && $showMonitorTab): ?>
<div class="content">
  <div class="title"><span class="left"><i class="fa fa-bolt title"></i>Power Monitoring</span></div>
  <div class="info-card">
    <h4>Current Readings</h4>
    <div class="readings-grid">
      <div class="readings-item">
        <p>Current Power: <span id="currentPower" class="highlight-value">--</span> W</p>
        <p>Daily Energy: <span id="dailyEnergy">--</span> kWh</p>
      </div>
      <div class="readings-item">
        <p>Daily Cost: <span id="dailyCost" class="highlight-value">--</span> <span id="costUnit"><?=$esphomepm_costs_unit?></span></p>
        <p>Monthly Cost: <span id="monthlyCost" class="highlight-value">--</span> <span id="costUnitMonthly"><?=$esphomepm_costs_unit?></span></p>
      </div>
    </div>
  </div>
  
  <div class="title"><span class="left"><i class="fa fa-area-chart title"></i>Power Graph</span></div>
  <div style="height: 250px; margin-top: 10px;">
    <canvas id="powerGraph"></canvas>
  </div>
</div>

<?php elseif ($tab == 'history' && $showMonitorTab): ?>
<div class="content">
  <div class="title"><span class="left"><i class="fa fa-history title"></i>Historical Data</span></div>
  <div class="info-card">
    <div class="total-stats">
      <div class="stat-item">
        <p>Total Energy: <span id="totalEnergy" class="highlight-value">--</span> kWh</p>
      </div>
      <div class="stat-item">
        <p>Total Cost: <span id="totalCost" class="highlight-value">--</span> <span id="historyCostUnit"><?=$esphomepm_costs_unit?></span></p>
      </div>
    </div>
  </div>
</div>
<?php endif; ?>

<script>
function resetForm(form) {
  form.DEVICE_NAME.value = "Unraid Server PM";
  form.DEVICE_IP.value = "";
  form.COSTS_PRICE.value = "0.27";
  form.COSTS_UNIT.value = "GBP";
}

function done() {
  window.location.href = '/Main';
}

document.addEventListener('DOMContentLoaded', function() {
  const tab = '<?=$tab?>';
  if (tab === 'monitoring' || tab === 'history') {
    updateDeviceStatus();
    setInterval(updateDeviceStatus, 10000);
  }
});

function updateDeviceStatus() {
  const deviceIP = '<?=$esphomepm_device_ip?>';
  if (!deviceIP) return;
  
  fetch('/plugins/esphomepm/status.php')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error:', data.error);
        return;
      }
      
      const tab = '<?=$tab?>';
      if (tab === 'monitoring') {
        if (data.power) document.getElementById('currentPower').textContent = parseFloat(data.power).toFixed(1);
        if (data.daily_energy) document.getElementById('dailyEnergy').textContent = parseFloat(data.daily_energy).toFixed(2);
        if (data.daily_cost) document.getElementById('dailyCost').textContent = parseFloat(data.daily_cost).toFixed(2);
        
        // Calculate and display monthly cost (estimated from daily cost)
        if (data.daily_cost) {
          const monthlyCostElement = document.getElementById('monthlyCost');
          if (monthlyCostElement) {
            const monthlyCost = parseFloat(data.daily_cost) * 30; // Approximate monthly cost
            monthlyCostElement.textContent = monthlyCost.toFixed(2);
          }
        }
      } else if (tab === 'history') {
        if (data.overall_total_energy) document.getElementById('totalEnergy').textContent = parseFloat(data.overall_total_energy).toFixed(2);
        if (data.overall_total_cost) document.getElementById('totalCost').textContent = parseFloat(data.overall_total_cost).toFixed(2);
      }
    })
    .catch(error => console.error('Fetch error:', error));
}
</script>

<?php if ($tab === 'monitoring'): ?>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
let powerChart;

document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('powerGraph').getContext('2d');
  powerChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Power (W)',
        data: [],
        borderColor: '#F57C00',
        backgroundColor: 'rgba(245, 124, 0, 0.2)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
  
  // Update graph every 5 seconds
  setInterval(updateGraph, 5000);
});

function updateGraph() {
  fetch('/plugins/esphomepm/status.php')
    .then(response => response.json())
    .then(data => {
      if (data.power) {
        const now = new Date();
        const timeLabel = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
        
        powerChart.data.labels.push(timeLabel);
        powerChart.data.datasets[0].data.push(parseFloat(data.power));
        
        if (powerChart.data.labels.length > 60) {
          powerChart.data.labels.shift();
          powerChart.data.datasets[0].data.shift();
        }
        
        powerChart.update();
      }
    })
    .catch(error => console.error('Graph update error:', error));
}
</script>
<?php endif; ?>

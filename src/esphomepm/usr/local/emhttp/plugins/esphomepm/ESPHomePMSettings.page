Menu="Utilities"
Icon="icon-bolt"
Title="ESPHome Power Monitor"
---
<?php
require_once("/usr/local/emhttp/plugins/esphomepm/data-handler.php");
$config = load_plugin_config();
$esphomepm_device_ip = isset($config['DEVICE_IP']) ? $config['DEVICE_IP'] : "";
$esphomepm_device_name = isset($config['DEVICE_NAME']) ? $config['DEVICE_NAME'] : "Unraid Server PM";
$esphomepm_costs_price = isset($config['COSTS_PRICE']) ? $config['COSTS_PRICE'] : "0.27";
$esphomepm_costs_unit = isset($config['COSTS_UNIT']) ? $config['COSTS_UNIT'] : "GBP";

// Determine which tab to show by default
$showMonitorTab = !empty($esphomepm_device_ip);
$tab = isset($_GET['tab']) ? $_GET['tab'] : ($showMonitorTab ? 'monitoring' : 'settings');
?>

<style>
/* General styling */
.highlight-value {
    font-size: 1.2em;
    font-weight: bold;
    color: #486DBA;
}

/* Card styling */
.info-card {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 30px;
    clear: both;
    overflow: hidden;
}

.notice {
    background-color: #f0f7ff;
    border-left: 4px solid #486DBA;
    padding: 15px;
    margin: 20px 0;
}

/* Content area */
.content {
    clear: both;
    padding-top: 20px;
}

/* Fix for tab styling to match Unraid */
#title input[type="button"] {
    margin-right: 0;
    border-radius: 0;
    border-right: none;
}

#title input[type="button"]:last-of-type {
    border-right: 1px solid #0090CA;
}

#title input[type="button"].active {
    background-color: #0090CA;
    color: white;
}

/* Improved layout for monitoring tab */
.readings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 15px;
}

.readings-item {
    margin-bottom: 15px;
}

.readings-item p {
    margin-bottom: 15px;
    font-size: 1.1em;
}

/* Fix for history tab */
.total-stats {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}

.stat-item {
    margin-right: 40px;
    margin-bottom: 20px;
}

/* Title styling */
.title {
    margin-bottom: 15px;
}

/* Icon size control */
.fa {
    font-size: 1em;
    margin-right: 5px;
}

/* Improve table layout */
table.settings {
    margin: 0 0 20px 0;
    width: auto;
    min-width: 50%;
}

table.settings td:first-child {
    width: 30%;
    padding-right: 10px;
}

/* Fix for canvas container */
#powerGraphContainer {
    height: 250px;
    margin-top: 10px;
    width: 100%;
    position: relative;
}
</style>

<div id="title">
  <span class="left">
    <input type="button" value="Settings" onclick="location='?tab=settings'" <?=($tab == 'settings') ? 'class="active"' : ''?>>
    <?php if ($showMonitorTab): ?>
    <input type="button" value="Monitoring" onclick="location='?tab=monitoring'" <?=($tab == 'monitoring') ? 'class="active"' : ''?>>
    <input type="button" value="History" onclick="location='?tab=history'" <?=($tab == 'history') ? 'class="active"' : ''?>>
    <?php endif; ?>
  </span>
</div>

<?php if ($tab == 'settings'): ?>
<div class="content">
  <div class="title"><span class="left"><i class="fa fa-cog"></i>Device Configuration</span></div>
  <form markdown="1" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#file" value="esphomepm/esphomepm.cfg">
    
    Device Name:
    : <input type="text" name="DEVICE_NAME" value="<?=$esphomepm_device_name?>" placeholder="ESPHome Device Name">
    
    Device IP:
    : <input type="text" name="DEVICE_IP" value="<?=$esphomepm_device_ip?>" placeholder="192.168.1.x">
    
    <div class="title"><span class="left"><i class="fa fa-money"></i>Cost Settings</span></div>
    
    Price per kWh:
    : <input type="text" name="COSTS_PRICE" value="<?=$esphomepm_costs_price?>" placeholder="0.00">
    
    Currency Unit:
    : <input type="text" name="COSTS_UNIT" value="<?=$esphomepm_costs_unit?>" placeholder="GBP">
    
    &nbsp;
    : <input type="button" value="Default" onclick="resetForm(this.form)"><input type="submit" value="Apply"><input type="button" value="Done" onclick="done()">
  </form>
  
  <?php if (empty($esphomepm_device_ip)): ?>
  <div class="notice">Please configure your ESPHome device IP address and click Apply to start monitoring.</div>
  <?php endif; ?>
</div>

<?php elseif ($tab == 'monitoring' && $showMonitorTab): ?>
<div class="content">
  <div class="title"><span class="left"><i class="fa fa-bolt"></i> Current Readings</span></div>
  <table class="settings">
    <tr>
      <td>Current Power:</td>
      <td><span id="currentPower" class="highlight-value">--</span> W</td>
    </tr>
    <tr>
      <td>Daily Energy:</td>
      <td><span id="dailyEnergy">--</span> kWh</td>
    </tr>
    <tr>
      <td>Daily Cost:</td>
      <td><span id="dailyCost" class="highlight-value">--</span> <span id="costUnit"><?=$esphomepm_costs_unit?></span></td>
    </tr>
    <tr>
      <td>Monthly Cost (est.):</td>
      <td><span id="monthlyCost" class="highlight-value">--</span> <span id="costUnitMonthly"><?=$esphomepm_costs_unit?></span></td>
    </tr>
  </table>
  
  <div class="title"><span class="left"><i class="fa fa-area-chart"></i>Power Graph</span></div>
  <div id="powerGraphContainer">
    <canvas id="powerGraph"></canvas>
  </div>
</div>

<?php elseif ($tab == 'history' && $showMonitorTab): ?>
<div class="content">
  <div class="title"><span class="left"><i class="fa fa-history"></i> Historical Data</span></div>
  <table class="settings">
    <tr>
      <td>Total Energy:</td>
      <td><span id="totalEnergy" class="highlight-value">--</span> kWh</td>
    </tr>
    <tr>
      <td>Total Cost:</td>
      <td><span id="totalCost" class="highlight-value">--</span> <span id="historyCostUnit"><?=$esphomepm_costs_unit?></span></td>
    </tr>
  </table>
</div>
<?php endif; ?>

<script>
function resetForm(form) {
  form.DEVICE_NAME.value = "Unraid Server PM";
  form.DEVICE_IP.value = "";
  form.COSTS_PRICE.value = "0.27";
  form.COSTS_UNIT.value = "GBP";
}

function done() {
  window.location.href = '/Main';
}

document.addEventListener('DOMContentLoaded', function() {
  const tab = '<?=$tab?>';
  if (tab === 'monitoring' || tab === 'history') {
    updateDeviceStatus();
    setInterval(updateDeviceStatus, 10000);
  }
});

function updateDeviceStatus() {
  const deviceIP = '<?=$esphomepm_device_ip?>';
  if (!deviceIP) return;
  
  fetch('/plugins/esphomepm/status.php')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error:', data.error);
        return;
      }
      
      const tab = '<?=$tab?>';
      if (tab === 'monitoring') {
        if (data.power) document.getElementById('currentPower').textContent = parseFloat(data.power).toFixed(1);
        if (data.daily_energy) document.getElementById('dailyEnergy').textContent = parseFloat(data.daily_energy).toFixed(2);
        if (data.daily_cost) document.getElementById('dailyCost').textContent = parseFloat(data.daily_cost).toFixed(2);
        
        // Calculate and display monthly cost (estimated from daily cost)
        if (data.daily_cost) {
          const monthlyCostElement = document.getElementById('monthlyCost');
          if (monthlyCostElement) {
            const monthlyCost = parseFloat(data.daily_cost) * 30; // Approximate monthly cost
            monthlyCostElement.textContent = monthlyCost.toFixed(2);
          }
        }
      } else if (tab === 'history') {
        if (data.overall_total_energy) document.getElementById('totalEnergy').textContent = parseFloat(data.overall_total_energy).toFixed(2);
        if (data.overall_total_cost) document.getElementById('totalCost').textContent = parseFloat(data.overall_total_cost).toFixed(2);
      }
    })
    .catch(error => console.error('Fetch error:', error));
}
</script>

<?php if ($tab === 'monitoring'): ?>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
let powerChart;

document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('powerGraph').getContext('2d');
  powerChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Power (W)',
        data: [],
        borderColor: '#F57C00',
        backgroundColor: 'rgba(245, 124, 0, 0.2)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Watts'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Time'
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      }
    }
  });
  
  // Update graph every 5 seconds
  setInterval(updateGraph, 5000);
});

function updateGraph() {
  fetch('/plugins/esphomepm/status.php')
    .then(response => response.json())
    .then(data => {
      if (data.power) {
        const now = new Date();
        const timeLabel = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
        
        powerChart.data.labels.push(timeLabel);
        powerChart.data.datasets[0].data.push(parseFloat(data.power));
        
        if (powerChart.data.labels.length > 60) {
          powerChart.data.labels.shift();
          powerChart.data.datasets[0].data.shift();
        }
        
        powerChart.update();
      }
    })
    .catch(error => console.error('Graph update error:', error));
}
</script>
<?php endif; ?>

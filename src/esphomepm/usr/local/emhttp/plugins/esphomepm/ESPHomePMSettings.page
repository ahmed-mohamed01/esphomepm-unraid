Menu="Utilities"
Title="ESPHome Power Monitor"
Icon="bolt"
---
<?php
// Include data handler
require_once("/usr/local/emhttp/plugins/esphomepm/data-handler.php");

// Load configuration
$config = load_plugin_config();

// Get device settings
$esphomepm_device_name = isset($config['DEVICE_NAME']) ? $config['DEVICE_NAME'] : "Unraid Server PM";
$esphomepm_device_ip = isset($config['DEVICE_IP']) ? $config['DEVICE_IP'] : "";
$esphomepm_costs_price = isset($config['COSTS_PRICE']) ? $config['COSTS_PRICE'] : "0.27";
$esphomepm_costs_unit = isset($config['COSTS_UNIT']) ? $config['COSTS_UNIT'] : "GBP";

// Determine if we should show the monitoring tab
$showMonitorTab = !empty($esphomepm_device_ip);

// Get current tab
$tab = isset($_GET['tab']) ? $_GET['tab'] : 'settings';
if (!in_array($tab, ['settings', 'monitoring', 'history'])) {
    $tab = 'settings';
}

// If monitoring tab is not available, redirect to settings
if (($tab == 'monitoring' || $tab == 'history') && !$showMonitorTab) {
    $tab = 'settings';
}
?>

<style>
/* Simple styling for Unraid compatibility */
.highlight-value {
    font-weight: bold;
    color: #F57C00;
}
</style>

<?if(function_exists('plugin_update_available') && $version = plugin_update_available('esphomepm')):?>
<div id="title" class="nocontrol">_(ESPHome Power Monitor)_ &nbsp;<?=$version?></div>
<?endif;?>

<form markdown="1" method="GET" action="/Settings/ESPHomePMSettings">
<div id="title">
  <span class="left">
    <input type="button" value="_(Settings)_" onclick="location='?tab=settings'" <?=($tab == 'settings') ? 'class="active"' : ''?>>
    <?php if ($showMonitorTab): ?>
    <input type="button" value="_(Monitoring)_" onclick="location='?tab=monitoring'" <?=($tab == 'monitoring') ? 'class="active"' : ''?>>
    <input type="button" value="_(History)_" onclick="location='?tab=history'" <?=($tab == 'history') ? 'class="active"' : ''?>>
    <?php endif; ?>
  </span>
</div>
</form>

<div class="clear"></div>

<?php if ($tab == 'settings'): ?>
<!-- Settings Tab Content -->
<form markdown="1" method="POST" action="/update.php" target="progressFrame">
  <input type="hidden" name="#file" value="esphomepm/esphomepm.cfg">
  
  <table class="settings">
    <tr>
      <td>Device Name:</td>
      <td><input type="text" name="DEVICE_NAME" value="<?=$esphomepm_device_name?>" placeholder="ESPHome Device Name"></td>
    </tr>
    <tr>
      <td>Device IP:</td>
      <td><input type="text" name="DEVICE_IP" value="<?=$esphomepm_device_ip?>" placeholder="192.168.1.x"></td>
    </tr>
    <tr>
      <td>Price per kWh:</td>
      <td><input type="text" name="COSTS_PRICE" value="<?=$esphomepm_costs_price?>" placeholder="0.00"></td>
    </tr>
    <tr>
      <td>Currency Unit:</td>
      <td><input type="text" name="COSTS_UNIT" value="<?=$esphomepm_costs_unit?>" placeholder="GBP"></td>
    </tr>
  </table>
  
  <div style="text-align: center; margin-top: 20px;">
    <input type="submit" value="Apply">
    <button type="button" onclick="done()">Done</button>
  </div>
</form>

<?php if (empty($esphomepm_device_ip)): ?>
<div style="background-color: rgba(0, 144, 202, 0.1); border-left: 4px solid #0090CA; padding: 15px; margin: 20px 0; color: #ccc;">
  <i class="fa fa-info-circle"></i> Please configure your ESPHome device IP address and click Apply to start monitoring.
</div>
<?php endif; ?>

<?php elseif ($tab == 'monitoring' && $showMonitorTab): ?>
<!-- Monitoring Tab Content -->
<table class="settings">
  <tr>
    <td>Current Power:</td>
    <td><span id="currentPower" class="highlight-value">--</span> W</td>
    <td>Daily Cost:</td>
    <td><span id="dailyCost" class="highlight-value">--</span> <span id="costUnit"><?=$esphomepm_costs_unit?></span></td>
  </tr>
  <tr>
    <td>Daily Energy:</td>
    <td><span id="dailyEnergy">--</span> kWh</td>
    <td>Monthly Cost (est.):</td>
    <td><span id="monthlyCost" class="highlight-value">--</span> <span id="costUnitMonthly"><?=$esphomepm_costs_unit?></span></td>
  </tr>
</table>

<div style="margin-top: 20px;">
  <h4>Power Graph</h4>
  <div id="powerGraphContainer" style="height: 300px;">
    <canvas id="powerGraph"></canvas>
  </div>
</div>

<?php elseif ($tab == 'history' && $showMonitorTab): ?>
<!-- History Tab Content -->
<h4>Historical Data</h4>
<table class="tablesorter">
  <thead>
    <tr>
      <th>Month</th>
      <th>Energy (kWh)</th>
      <th>Cost (<?=$esphomepm_costs_unit?>)</th>
    </tr>
  </thead>
  <tbody id="monthlyHistory">
    <tr>
      <td colspan="3">Loading historical data...</td>
    </tr>
  </tbody>
</table>

<h4>Total Statistics</h4>
<table class="settings">
  <tr>
    <td>Total Energy:</td>
    <td><span id="totalEnergy" class="highlight-value">--</span> kWh</td>
  </tr>
  <tr>
    <td>Total Cost:</td>
    <td><span id="totalCost" class="highlight-value">--</span> <?=$esphomepm_costs_unit?></td>
  </tr>
  <tr>
    <td>Monitoring Since:</td>
    <td><span id="monitoringSince">--</span></td>
  </tr>
</table>

<?php endif; ?>

<script>
// Basic functions to update data
function updateDeviceStatus() {
  const deviceIP = '<?=$esphomepm_device_ip?>';
  if (!deviceIP) return;
  
  fetch('/plugins/esphomepm/status.php')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error:', data.error);
        return;
      }
      
      // Update current readings
      document.getElementById('currentPower').textContent = data.power;
      document.getElementById('dailyEnergy').textContent = data.today_energy.toFixed(2);
      document.getElementById('dailyCost').textContent = data.daily_cost.toFixed(2);
      document.getElementById('monthlyCost').textContent = data.monthly_cost_est.toFixed(2);
      
      // Update history data if available
      if (data.historical_data_available) {
        updateHistoricalData(data);
      }
    })
    .catch(error => {
      console.error('Fetch error:', error);
    });
}

function updateHistoricalData(data) {
  // Update total statistics
  if (document.getElementById('totalEnergy')) {
    document.getElementById('totalEnergy').textContent = data.overall_total_energy.toFixed(2);
    document.getElementById('totalCost').textContent = data.overall_total_cost.toFixed(2);
    document.getElementById('monitoringSince').textContent = data.monitoring_start_date;
  }
  
  // Update monthly history table
  if (document.getElementById('monthlyHistory')) {
    updateMonthlyHistoryTable(data.historical_months, data.current_month);
  }
}

function updateMonthlyHistoryTable(historicalMonths, currentMonth) {
  const monthlyHistoryElement = document.getElementById('monthlyHistory');
  if (!monthlyHistoryElement) return;
  
  let tableContent = '';
  const costUnit = '<?=$esphomepm_costs_unit?>';
  
  // Add current month if available
  if (currentMonth && currentMonth.month_year) {
    const monthName = getMonthNameFromYearMonth(currentMonth.month_year);
    const energy = parseFloat(currentMonth.total_energy_kwh_completed_days || 0).toFixed(2);
    const cost = parseFloat(currentMonth.total_cost_completed_days || 0).toFixed(2);
    
    tableContent += `<tr>
      <td>${monthName}</td>
      <td>${energy}</td>
      <td>${cost} ${costUnit}</td>
    </tr>`;
  }
  
  // Add historical months
  if (historicalMonths && typeof historicalMonths === 'object') {
    const sortedMonths = Object.keys(historicalMonths).sort().reverse();
    
    for (const monthYear of sortedMonths) {
      const monthData = historicalMonths[monthYear];
      if (monthData) {
        const monthName = getMonthNameFromYearMonth(monthYear);
        const energy = parseFloat(monthData.energy_kwh || 0).toFixed(2);
        const cost = parseFloat(monthData.cost || 0).toFixed(2);
        
        tableContent += `<tr>
          <td>${monthName}</td>
          <td>${energy}</td>
          <td>${cost} ${costUnit}</td>
        </tr>`;
      }
    }
  }
  
  // If no data, show message
  if (tableContent === '') {
    tableContent = '<tr><td colspan="3">No historical data available</td></tr>';
  }
  
  monthlyHistoryElement.innerHTML = tableContent;
}

function getMonthNameFromYearMonth(yearMonth) {
  if (!yearMonth) return 'Unknown';
  
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                 'July', 'August', 'September', 'October', 'November', 'December'];
  
  const parts = yearMonth.split('-');
  if (parts.length !== 2) return yearMonth;
  
  const year = parts[0];
  const month = parseInt(parts[1], 10);
  
  if (isNaN(month) || month < 1 || month > 12) return yearMonth;
  
  return `${months[month-1]} ${year}`;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  const tab = '<?=$tab?>';
  if (tab === 'monitoring' || tab === 'history') {
    updateDeviceStatus();
    setInterval(updateDeviceStatus, 10000);
  }
});
</script>

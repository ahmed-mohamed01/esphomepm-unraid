Menu="Dashboard:4"
Title="ESPHome Power Monitor"
Icon="bolt"
---
<?php
    require_once("/usr/local/emhttp/plugins/esphomepm/include/functions.php");
    $config = esphomepm_load_config();
    $costs_unit = isset($config['COSTS_UNIT']) ? $config['COSTS_UNIT'] : "GBP";
?>

<style>
    .dash_esphomepm .header {
        font-weight: bold;
    }
    .dash_esphomepm .value {
        font-weight: bold;
        color: #F57C00;
    }
    .dash_esphomepm .fa-bolt {
        color: #F57C00;
    }
</style>

<table class='dash_esphomepm dashboard'>
    <thead><tr><td></td><td></td><td></td><td></td><td></td></tr></thead>
    <tbody>
        <tr>
            <td></td>
            <td colspan='3' class='next'>
                <i class='fa fa-bolt'></i>
                <div style='display:inline-block;margin-left:10px'>
                    <span class='header'>_(ESPHome Power Monitor)_</span><br>
                    <span>_(Current Power)_: <span class='value esphomepm-current-power'>0</span> W</span>
                </div>
                <a href='/Settings/ESPHomePMSettings' title="_(Go to ESPHome Power Monitor settings)_"><i class='fa fa-fw fa-cog control'></i></a>
            </td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td>
                <span>_(Daily Power)_:</span><br>
                <span>_(Monthly Power)_:</span><br>
                <span>_(Total Power)_:</span>
            </td>
            <td>
                <span class='esphomepm-energy-today'>0.00</span> kWh<br>
                <span class='esphomepm-energy-month'>0.00</span> kWh<br>
                <span class='esphomepm-energy-total'>0.00</span> kWh
            </td>
            <td>
                <span>_(Daily Cost)_:</span><br>
                <span>_(Monthly Cost)_:</span><br>
                <span>_(Total Cost)_:</span>
            </td>
            <td>
                <span class='value esphomepm-costs_today'>0.00</span> <?=$costs_unit?><br>
                <span class='value esphomepm-costs_month'>0.00</span> <?=$costs_unit?><br>
                <span class='value esphomepm-costs_total'>0.00</span> <?=$costs_unit?>
            </td>
        </tr>
    </tbody>
</table>
<script>
// Update ESPHome Power Monitor dashboard widget
function esphomepm_status() {
    $.getJSON("/plugins/esphomepm/status.php", function(data) {
        if (!data) return;
        
        // Current power
        updateValue('.esphomepm-current-power', data.power, 2);
        
        // Energy values
        updateValue('.esphomepm-energy-today', data.today_energy, 3);
        updateValue('.esphomepm-energy-month', data.current_month_energy_total, 3);
        updateValue('.esphomepm-energy-total', data.overall_total_energy, 3);
        
        // Cost values
        updateValue('.esphomepm-costs_today', data.daily_cost, 2);
        updateValue('.esphomepm-costs_month', data.current_month_cost_total, 2);
        updateValue('.esphomepm-costs_total', data.overall_total_cost, 2);
    });
}

// Helper function to update values with proper formatting
function updateValue(selector, value, decimals) {
    if (value !== undefined) {
        $(selector).html(parseFloat(value).toFixed(decimals));
    } else {
        $(selector).html('0.00');
    }
}

$(document).ready(function() {
    // Initial status update
    esphomepm_status();
    
    // Set up refresh interval (10 seconds)
    setInterval(esphomepm_status, 10000);
});
</script>